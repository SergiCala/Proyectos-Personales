import gzip
import random
import ssl
import time
from urllib.request import Request, urlopen
from bs4 import BeautifulSoup as bs
ssl._create_default_https_context = ssl._create_unverified_context



headers = {
    "Host": "www.idealista.com",
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/109.0",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,/;q=0.8",
    "Accept-Language": "es-ES,es;q=0.8,en-US;q=0.5,en;q=0.3",
    "Accept-Encoding": "gzip, deflate, br",
    "Connection": "keep-alive",
    "Upgrade-Insecure-Requests": "1",
    "Sec-Fetch-Dest": "document",
    "Sec-Fetch-Mode": "navigate",
    "Sec-Fetch-Site": "cross-site",
}

busqueda = "marbella"
busqueda = busqueda.replace(" ", "_")
ids = []

pagina = 1

while True:
    if pagina > 200:
        break

    try:
        url = f"https://www.idealista.com/buscar/venta-viviendas/{busqueda}/pagina-{pagina}.htm"
        req = Request(url, headers=headers)
        respuesta = urlopen(req, timeout=10)
    except:
        print("Error: ")
        break

    print(respuesta.geturl())


    scripts = bs.find_all("script")

    for script in scripts:
        if "var config" in str(script):
            break
    latitude = float(str(script).split("latitude")[1].split(",")[0].split()[1].replace("`",""))
    longitude = float(str(script).split("latitude")[1].split(",")[1].split()[1].replace("`", ""))

# Si la url devuelta es diferente a la pedida, se rompera el bucle
# La primera pagina posee un formato diferente por tanto es una excepcion

    url_diferente = url != respuesta.geturl() and pagina > 1

    if respuesta.getcode() != 200 or url_diferente:
        break

    print("Analizando: ", pagina)
    html_page = gzip.decompress(respuesta.read()).decode('utf-8')
    soup = bs(html_page, "lxml")

    articles = soup.find("main", {"class": "listing-items"}).find_all("article")

    for article in articles:
        id_inmuebles = article.get("data-adid")
        ids.append(id_inmuebles)

    print(ids)
    pagina += 1
    time.sleep(random.randint(1, 3))

print("")
print(f"Total de ids:{ids}")
print(f"Total de paginas {pagina}")

